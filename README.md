# Mermaid Diagram Exporter (Web App)  
<img width="1336" height="761" alt="スクリーンショット 2025-10-08 22 16 50" src="https://github.com/user-attachments/assets/da925cd8-0ba9-4e12-8d3a-4257ca178de8" />

## 概要

[Mermaid](https://mermaid-js.github.io/mermaid/#/) で記述されたフロー図やダイアグラムを、PNG, SVG, PDF画像として簡単にエクスポートしたり、クリップボードにコピーしたりするためのWebアプリケーションです。

JOBフロー図などの視覚化されたプロセスを、ドキュメントやプレゼンテーションに簡単に貼り付けられる形式で保存することを目的としています。

## 主な機能

- **高機能エディタ**: シンタックスハイライトや自動補完が効くMonaco Editorを搭載。
- **サンプルコード**: フローチャート、シーケンス図、ガントチャートなどのサンプルをドロップダウンから簡単に挿入できます。
- **自動ライブプレビュー**: 入力されたコードを即座にレンダリングし、プレビューを自動更新します。**プレビューの背景は常に明るい色（薄いグレー）に固定され、視認性を確保します。**
- **テーマ選択**: `default`, `dark`, `forest`, `neutral` などのテーマを切り替えて、ダイアグラムの見た目を変更できます。**このテーマは主にエクスポートされる画像に適用されます。**
- **多彩なエクスポート形式**: レンダリングされたダイアグラムを、**SVG**, **PNG**, **PDF**形式でダウンロードできます。
- **クリップボードへのコピー**: プレビュー画像を直接クリップボードにコピーして、他のアプリケーションに簡単に貼り付けられます。
- **高解像度出力**: PNGやクリップボードへのコピー時に、解像度（スケール）を選択して、鮮明な画像を出力できます。

## 使い方

1. アプリケーションのURLにアクセスします。
2. 左側のエディタにMermaid形式のコードを入力するか、上部の **「サンプル」** ドロップダウンから好きな図を選択します。
3. コードを編集すると、右側のプレビューエリアが自動で更新されます。
4. 上部のドロップダウンメニューから、お好みの **エクスポートテーマ** や **エクスポート解像度** を選択します。
5. **「SVG保存」**, **「PDF保存」**, **「PNG保存」** ボタンをクリックすると、各種形式で画像ファイルがダウンロードされます。
6. **「コピー」** ボタンをクリックすると、プレビュー画像がクリップボードにコピーされます。

## 技術スタック

- **フレームワーク**: [Next.js](https://nextjs.org/) (React)
- **UI**: [shadcn/ui](https://ui.shadcn.com/), [Tailwind CSS](https://tailwindcss.com/)
- **言語**: [TypeScript](https://www.typescriptlang.org/)
- **ダイアグラムレンダリング**: [Mermaid.js](https://mermaid-js.github.io/mermaid/#/)
- **PNG/PDF生成 (クライアントサイド)**: [html-to-image](https://github.com/bubkoo/html-to-image), [jsPDF](https://github.com/parallax/jsPDF)
- **コードエディタ**: [Monaco Editor](https://microsoft.github.io/monaco-editor/)
- **アイコン**: [Lucide React](https://lucide.dev/)
- **通知**: [Sonner](https://sonner.emilkowal.ski/)
- **テーマ管理**: [next-themes](https://github.com/pacocoursey/next-themes)

## 処理フロー

現在のアーキテクチャでは、すべての画像生成処理がブラウザ（クライアントサイド）で完結します。ユーザーが見ているプレビュー領域を直接画像化することで、安定した出力を実現しています。

```mermaid
flowchart TD
    subgraph "フロントエンド (ブラウザ)"
        A[ユーザーがEditorにMermaid記法を入力] --> B{useMermaidフック};
        B --> C[クライアントサイドでSVGを生成];
        C --> D["PreviewCardにSVGをリアルタイム表示<br>(id='mermaid-preview-area')"];
        
        E[ユーザーがエクスポート/コピーボタンをクリック] --> F{useMermaidフック};
        F -- "id='mermaid-preview-area' を渡す" --> G{exporter.ts モジュール};
        G --> H["html-to-imageライブラリで<br>プレビュー要素を直接画像化"];
        H --> I{PNG/PDF形式を選択};
        I --> J[ファイルをダウンロード or クリップボードにコピー];
    end

    style A fill:#590159,stroke:#590159,stroke-width:2px
    style E fill:#590159,stroke:#590159,stroke-width:2px
    style J fill:#590159,stroke:#590159,stroke-width:2px
```

## プロジェクト構造

リファクタリングにより、コードベースは役割ごとに分割されています。

- `app/` - Next.jsのApp Router。アプリケーションのエントリーポイント(`page.tsx`)が含まれます。
- `components/` - UIコンポーネント。
  - `ui/` - `shadcn/ui`によって自動生成された基本的なUI部品（Button, Cardなど）。
  - `app/` - アプリケーション固有の複合コンポーネント（Header, ControlPanelなど）。
- `hooks/` - カスタムフック。`use-mermaid.ts`に状態管理とUIイベントのハンドリングが集約されています。
- `lib/` - ユーティリティ関数とビジネスロジック。
  - `utils.ts` - `shadcn/ui`が使用するユーティリティ関数。
  - `exporter.ts` - SVGからの画像/PDF生成、クリップボードへのコピーといったエクスポート処理を集約したモジュール。

## ローカルでの開発方法

### 前提条件

- [Node.js](https://nodejs.org/) (LTS版を推奨) がインストールされていること。

### 手順

1.  **依存関係のインストール**
    プロジェクトのルートディレクトリで以下のコマンドを実行し、必要なライブラリをインストールします。
    ```bash
    npm install
    ```

2.  **開発サーバーの起動**
    インストール完了後、以下のコマンドで開発サーバーを起動します。
    ```bash
    npm run dev
    ```

3.  ブラウザで `http://localhost:3000` を開きます。

## Vercelで安定稼働させるための技術的ポイント

このアプリケーションは、Vercelのようなモダンなホスティング環境で安定して動作するよう、いくつかの重要な設計上の判断と技術的な工夫を取り入れています。同様のアプリケーションを開発する際の参考情報として、そのポイントを以下にまとめます。

1.  **アーキテクチャ: 完全クライアントサイド生成**
    Vercelのサーバーレス関数は、長時間の処理や大きなメモリを消費するタスク（例: Puppeteerによるブラウザ操作）には不向きで、タイムアウトや実行時エラーの原因となります。この問題を根本的に回避するため、本アプリはMermaidのレンダリングからPNG/PDFの画像生成まで、**すべての処理をユーザーのブラウザ内で完結させる「完全クライアントサイド生成」**のアーキテクチャを採用しています。Vercelは静的ファイルのホスティングに徹することで、高速かつ安定した動作を実現しています。

2.  **画像生成: `html-to-image`によるDOMの直接キャプチャ**
    当初、`canvg`などのSVG変換ライブラリを試しましたが、フォントの描画漏れなどの問題が発生しました。最終的に、表示されているDOM要素を忠実に画像化することに長けた`html-to-image`ライブラリを採用しました。
    また、エクスポートの都度、非表示の要素を裏で生成する方式は不安定だったため、**画面に表示されているプレビュー領域のDOM要素を直接キャプチャする**方式に変更しました。これにより、「ユーザーが見ているまま」の状態が確実にエクスポートされるようになっています。

3.  **CORSエラーの回避: ライブラリオプションの活用**
    `html-to-image`のようなライブラリは、スタイルを再現するためにページ上のCSSをスキャンしようとします。これが外部ドメインのCSS（CDN上のフォントファイルなど）にアクセスしようとすると、ブラウザのセキュリティポリシー（CORS）に違反し、エラーを引き起こします。これを解決するため、ライブラリの`skipFonts: true`オプションを使用し、フォントに関する過剰な処理を無効化しています。

4.  **SVGの互換性: `foreignObject`の回避**
    Mermaidは、デフォルトでは図のラベルをHTMLとして扱うため、SVG内に`<foreignObject>`という特殊な要素を生成します。これは多くの画像化ライブラリでサポートが不完全であり、文字化けや描画崩れの原因となります。Mermaidの初期化設定で`htmlLabels: false`を指定することで、ラベルを標準的なSVGの`<text>`要素として描画させ、互換性を大幅に向上させています。

5.  **フォント管理: `next/font`の利用**
    Next.jsプロジェクトでは、`<link>`タグで直接フォントを読み込むのではなく、Next.jsに統合された`next/font`を利用することが推奨されています。これにより、フォントファイルがビルド時に最適化され、パフォーマンスが向上します。本アプリでも`next/font/google`を使い、アプリケーション全体でフォントを効率的に管理しています。

## 課題と経緯

### 【解決済み】Vercel環境でのサーバーサイド実行エラー

- **問題**: 当初、PNG/PDF生成をサーバーサイド(Next.js API Route)でPuppeteerを用いて行っていましたが、Vercelのサーバーレス環境ではChromiumの実行パスの問題が解決できず、デプロイ環境でエクスポート機能が一切動作しないという致命的な問題を抱えていました。
- **解決策**: この問題を根本的に解決するため、アーキテクチャを「完全クライアント生成型」に全面的に刷新しました。サーバーサイドでの処理をすべて撤廃し、ブラウザ上ですべての画像・PDF生成を完結させるように変更しました。これにより、Vercelの実行環境への依存がなくなり、アプリケーションは静的サイトとして安定して動作するようになりました。

### 【解決済み】エクスポート機能の安定化

- **現象**: クライアント生成への移行後、エクスポートした画像で文字が消えたり、画像生成自体に失敗する問題が断続的に発生していました。

- **原因**: 複数の要因が複合的に絡み合っていました。
    1.  **ライブラリとCORSの問題**: 画像生成ライブラリ(`canvg`, `save-svg-as-png`, `html-to-image`)が、ページに読み込まれている外部CSS（Google Fonts, Monaco Editor）を処理しようとして、ブラウザのセキュリティ制限（CORS）に抵触していました。
    2.  **SVGの互換性**: MermaidがデフォルトでHTMLラベル（`<foreignObject>`）を使用しており、これが多くの画像生成ライブラリで正しく解釈されませんでした。
    3.  **不安定なアーキテクチャ**: エクスポートの都度、非表示のDOM要素を裏で生成する方式だったため、タイミングによってレンダリングが不完全になる問題がありました。

- **対策**: 以下の抜本的な修正を行いました。
    1.  **MermaidのSVG生成を改善**: Mermaidの初期化時に`htmlLabels: false`を指定し、互換性の高い標準的なSVGテキスト (`<text>`) を生成するように変更しました。
    2.  **画像生成ライブラリの最適化**: ライブラリを`html-to-image`に統一し、フォント処理をスキップするオプション (`skipFonts: true`) を指定。これにより、CORSエラーを根本的に回避しました。
    3.  **アーキテクチャの刷新**: 裏で要素を生成する方式を廃止し、**画面に表示されているプレビュー領域そのもの**を直接画像化する方式に変更しました。これにより、ユーザーが見ている通りの内容が確実にエクスポートされるようになり、安定性が大幅に向上しました。